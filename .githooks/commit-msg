#!/usr/bin/env sh

set -eu

COMMIT_MSG_FILE="$1"
FIRST_LINE="$(sed -n '1p' "$COMMIT_MSG_FILE")"

# Allow merge commits generated by Git.
if printf '%s' "$FIRST_LINE" | grep -Eq '^Merge '; then
  exit 0
fi

# Allow conventional commit prefixes commonly used during autosquash.
if printf '%s' "$FIRST_LINE" | grep -Eq '^(fixup! |squash! )'; then
  FIRST_LINE="$(printf '%s' "$FIRST_LINE" | sed -E 's/^(fixup! |squash! )//')"
fi

# Conventional Commits:
# type(scope)!: subject
# type!: subject
# type: subject
if printf '%s' "$FIRST_LINE" | grep -Eq '^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z0-9._/-]+\))?(!)?: .+'; then
  exit 0
fi

echo "Invalid commit message format:"
echo "  $FIRST_LINE"
echo
echo "Expected Conventional Commits, for example:"
echo "  feat: add profile selector"
echo "  fix(runtime): guard null SkyScript fs"
echo "  refactor(app)!: simplify startup flow"
exit 1
